<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Messages - End2Friend</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=arrow_back,chat,drone_2,person" />
    <style>
        body { font-family: "Varela Round", sans-serif; }
        .nav-link { display:flex; align-items:center; gap:12px; padding:12px; border-radius:8px; color:#6b7280; text-decoration:none; margin-bottom:4px; }
        .nav-link:hover { background:#f3e8ff; color:#7c3aed; }
    </style>
</head>
<body class="bg-purple-50 min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-56 bg-white shadow-md flex flex-col">
        <div class="p-5 flex items-center gap-2 text-purple-600 border-b border-purple-100">
            <span class="material-symbols-outlined">drone_2</span>
            <h1 class="font-bold text-lg">End2Friend</h1>
        </div>
        <div class="p-5 flex items-center gap-3 border-b border-purple-100">
            <div class="w-10 h-10 bg-purple-200 rounded-full flex items-center justify-center">
                <span class="material-symbols-outlined text-purple-600">person</span>
            </div>
            <span class="text-gray-700 text-sm">{{ request.user.username }}</span>
        </div>
        <nav class="flex-1 p-4">
            <a href="{% url 'dashboard' %}" class="nav-link">
                <span class="material-symbols-outlined">arrow_back</span>
                Dashboard
            </a>
            <a href="{% url 'people' %}" class="nav-link">
                <span class="material-symbols-outlined">person</span>
                People
            </a>
            <a href="{% url 'inbox' %}" class="nav-link" style="background:#ede9fe; color:#7c3aed;">
                <span class="material-symbols-outlined">chat</span>
                Messages
            </a>
        </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-8 max-w-2xl">
        <h1 class="text-xl font-bold text-gray-800 mb-6">Messages</h1>

        <!-- Start new DM -->
        <div class="bg-white rounded-xl shadow p-4 mb-6">
            <p class="text-sm text-gray-500 mb-2">Start a new conversation</p>
            <div class="flex gap-2">
                <input type="text" id="dm-username" placeholder="Enter a username..."
                    class="flex-1 border border-purple-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-400" />
                <button onclick="startDM()"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700">
                    Message
                </button>
            </div>
        </div>

        <!-- Conversation List -->
        <div class="bg-white rounded-xl shadow divide-y divide-gray-100">
            {% for convo in conversations %}
            <a href="{% url 'chat_room' convo.room_id %}" class="flex items-center gap-3 p-4 hover:bg-purple-50 transition">
                <div class="w-10 h-10 bg-purple-200 rounded-full flex items-center justify-center font-bold text-purple-700">
                    {% for participant in convo.participants.all %}
                        {% if participant != request.user %}{{ participant.username|first|upper }}{% endif %}
                    {% endfor %}
                </div>
                <div class="flex-1">
                    <p class="text-gray-800 font-medium text-sm">
                        {% for participant in convo.participants.all %}
                            {% if participant != request.user %}{{ participant.username }}{% endif %}
                        {% endfor %}
                    </p>
                    <p class="text-xs text-gray-400">
                        {% with last=convo.messages.last %}
                            {% if last %}{{ last.content|truncatechars:40 }}{% else %}No messages yet{% endif %}
                        {% endwith %}
                    </p>
                </div>
            </a>
            {% empty %}
            <div class="p-6 text-center text-gray-400 text-sm">No conversations yet. Start one above or find someone in People!</div>
            {% endfor %}
        </div>
    </main>

    <script>
        function startDM() {
            const username = document.getElementById('dm-username').value.trim();
            if (username) window.location.href = `/chat/dm/${username}/`;
        }
        document.getElementById('dm-username').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') startDM();
        });
    </script>

</body>
</html>