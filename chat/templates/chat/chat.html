<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% if other_user %}{{ other_user.username }}{% else %}{{ room_name }}{% endif %} - Chat</title>

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- Main font -->
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

    <!-- REQUIRED for all Material Symbols icons -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
</head>

<body class="bg-gray-100">
    <div class="flex h-screen">

        <!-- LEFT SIDEBAR - Channels List -->
        <aside class="w-72 bg-white flex flex-col border-r border-gray-200">

    <!-- Logo -->
    <div class="p-4 border-b border-gray-100">
        <div class="flex items-center gap-2 text-purple-600">
            <span class="material-symbols-outlined">drone_2</span>
            <h1 class="font-bold text-lg">End2Friend</h1>
        </div>
    </div>

    <!-- Search -->
    <div class="p-4">
        <div class="flex items-center gap-2 bg-gray-100 rounded-xl px-4 py-2.5">
            <span class="material-symbols-outlined text-gray-400 text-xl">search</span>
            <input type="text" placeholder="Search..." class="bg-transparent text-sm flex-1 outline-none text-gray-600">
        </div>
    </div>

    <!-- CHANNELS -->
    <div class="px-4 mb-2">
        <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Channels</p>
    </div>

    <div class="flex-1 overflow-y-auto px-3">
        {% for channel in channels %}
        <a href="{% url 'chat_room' channel.name %}"
           class="channel-item {% if channel.name == room_name %}active{% endif %}">
            <div class="relative">
                <div class="w-11 h-11 rounded-full flex items-center justify-center text-white font-bold"
                     style="background: linear-gradient(135deg, #9B76B4 0%, #E8B4D4 100%);">
                    {{ channel.name|first|upper }}
                </div>
                <div class="online-dot"></div>
            </div>
            <div class="flex-1 min-w-0">
                <p class="font-medium text-gray-800 text-sm">#{{ channel.name }}</p>
                <p class="text-xs text-gray-400 truncate">Click to open chat</p>
            </div>
        </a>
        {% empty %}
        <p class="text-center text-gray-400 text-sm py-4">No channels yet</p>
        {% endfor %}
    </div>

    <!-- DIRECT MESSAGES -->
    <div class="px-4 mt-4 mb-2">
        <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Direct Messages</p>
    </div>

    <div class="flex-1 overflow-y-auto px-3">
        {% for convo in conversations %}
        <a href="{% url 'chat_room' convo.room_id %}"
           class="channel-item {% if convo.room_id == room_name %}active{% endif %}">
            <div class="w-11 h-11 rounded-full flex items-center justify-center text-white font-bold"
                 style="background: linear-gradient(135deg, #7C3AED 0%, #C4B5FD 100%);">
                {% for p in convo.participants.all %}
                    {% if p != request.user %}{{ p.username|first|upper }}{% endif %}
                {% endfor %}
            </div>
            <div class="flex-1 min-w-0">
                <p class="font-medium text-gray-800 text-sm">
                    {% for p in convo.participants.all %}
                        {% if p != request.user %}{{ p.username }}{% endif %}
                    {% endfor %}
                </p>
                <p class="text-xs text-gray-400 truncate">
                    {% with last=convo.messages.last %}
                        {% if last %}{{ last.content|truncatechars:40 }}{% else %}No messages yet{% endif %}
                    {% endwith %}
                </p>
            </div>
        </a>
        {% empty %}
        <p class="text-center text-gray-400 text-sm py-4">No conversations yet</p>
        {% endfor %}
    </div>

    <!-- Bottom Nav -->
    <div class="p-3 border-t border-gray-100 space-y-1">
        <a href="{% url 'dashboard' %}" class="info-link">
            <span class="material-symbols-outlined text-lg">dashboard</span>
            Dashboard
        </a>
        <a href="{% url 'people' %}" class="info-link">
            <span class="material-symbols-outlined text-lg">person</span>
            People
        </a>
        <a href="{% url 'inbox' %}" class="info-link">
            <span class="material-symbols-outlined text-lg">chat</span>
            Messages
        </a>
    </div>

</aside>


        <!-- MIDDLE - Chat Area -->
        <main class="flex-1 flex flex-col bg-purple-50">
            
            <!-- Chat Header -->
            <div class="p-4 bg-white border-b border-gray-200 flex items-center gap-4">
    <div class="relative">
        <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg" style="background: linear-gradient(135deg, #9B76B4 0%, #E8B4D4 100%);">
            {{ room_name|first|upper }}
        </div>
        <div class="online-dot"></div>
    </div>

    <div class="max-w-xs">
        {% if message.user != request.user %}
        <p class="text-xs text-gray-400 mb-1">{{ message.user.username }}</p>
        {% endif %}
        <div class="rounded-xl px-3 py-2 text-sm
            {% if message.user == request.user %}
            bg-purple-600 text-white rounded-tr-none
            {% else %}
            bg-gray-100 text-gray-800 rounded-tl-none
            {% endif %}">
            {{ message.content }}
        </div>
        <p class="text-xs text-gray-400 mt-1">{{ message.timestamp|timesince }} ago</p>
    </div>
</div>


<!-- Messages Area -->
<div id="chat-log" class="flex-1 overflow-y-auto p-6 space-y-4">
    {% for message in messages %}
        {% if message.user == request.user %}
            <!-- Sent message (right side) -->
            <div class="flex justify-end">
                <div class="max-w-md">
                    <p class="text-xs text-gray-400 text-right mb-1">{{ message.timestamp|timesince }} ago</p>
                    <div class="msg-sent px-4 py-3 text-sm shadow-sm">
                        {{ message.content }}
                    </div>
                </div>
            </div>
        {% else %}
            <!-- Received message (left side) -->
            <div class="flex gap-3">
                <div class="w-9 h-9 rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0"
                     style="background: linear-gradient(135deg, #7C3AED 0%, #C4B5FD 100%);">
                    {{ message.user.username|first|upper }}
                </div>
                <div class="max-w-md">
                    <p class="text-xs text-gray-500 mb-1">
                        <span class="font-medium text-gray-700">{{ message.user.username }}</span>
                        · {{ message.timestamp|timesince }} ago
                    </p>
                    <div class="msg-received px-4 py-3 text-sm shadow-sm">
                        {{ message.content }}
                    </div>
                </div>
            </div>
        {% endif %}
    {% empty %}
        <!-- Empty state -->
        <div class="flex flex-col items-center justify-center h-full text-center">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mb-4"
                 style="background: linear-gradient(135deg, #E8B4D4 0%, #C4B5FD 100%);">
                <span class="material-symbols-outlined text-4xl text-white">chat</span>
            </div>
            <h3 class="text-xl font-bold text-gray-700 mb-2">Welcome to #{{ room_name }}</h3>
            <p class="text-sm text-gray-400">This is the start of your conversation.<br>Say hello!</p>
            <p class="text-center text-gray-400 text-sm mt-8">No messages yet. Say hello!</p>
        </div>
    {% endfor %}
</div>


            <!-- Input Area -->
            <div class="p-4 bg-white border-t border-gray-200">
                <div class="flex gap-3 items-center">
                    <input id="messageInput" type="text" placeholder="Type a message..."
                        class="flex-1 bg-gray-100 rounded-full px-5 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-purple-400">
                    <button id="sendBtn" class="w-12 h-12 rounded-full flex items-center justify-center text-white shadow-lg transition hover:opacity-90" style="background: linear-gradient(135deg, #9B76B4 0%, #E8B4D4 100%);">
                        <span class="material-symbols-outlined">send</span>
                    </button>
                </div>
            </div>
        </main>

        <!-- RIGHT SIDEBAR - Info Panel -->
        <aside class="w-72 bg-white border-l border-gray-200 flex flex-col">
            
            <!-- Channel Info Header -->
            <div class="p-6 border-b border-gray-100 text-center">
                <div class="w-20 h-20 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-2xl font-bold" style="background: linear-gradient(135deg, #9B76B4 0%, #E8B4D4 100%);">
                    {{ room_name|first|upper }}
                </div>
                <h3 class="font-bold text-gray-800 text-lg">#{{ room_name }}</h3>
                <p class="text-sm text-gray-400">{{ conversation.participants.count }} member{{ conversation.participants.count|pluralize }}</p>
            </div>

            <!-- Quick Links -->
            <div class="p-4 space-y-1">
                <div class="info-link">
                    <span class="material-symbols-outlined text-lg" style="color: #9B76B4;">star</span>
                    <span>Starred Messages</span>
                    <span class="ml-auto text-xs text-gray-400">(0)</span>
                </div>
                <div class="info-link">
                    <span class="material-symbols-outlined text-lg" style="color: #9B76B4;">group</span>
                    <span>Members</span>
                    <span class="ml-auto text-xs text-gray-400">({{ conversation.participants.count }})</span>
                </div>
            </div>

            <!-- Members List -->
            <div class="px-4 mb-2">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Members</p>
            </div>
            <div class="flex-1 overflow-y-auto px-4 space-y-3">
                {% for member in conversation.participants.all %}
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-9 h-9 rounded-full flex items-center justify-center text-white text-sm font-bold" style="background: linear-gradient(135deg, #7C3AED 0%, #C4B5FD 100%);">
                            {{ member.username|first|upper }}
                        </div>
                        <div class="online-dot"></div>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-700">{{ member.username }}</p>
                        <p class="text-xs text-purple-500">Online</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-sm text-gray-400">No members yet</p>
                {% endfor %}
            </div>

            <!-- User & Logout -->
            <div class="p-4 border-t border-gray-100">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-purple-200 rounded-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-purple-600">person</span>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-700">{{ request.user.username }}</p>
                        <p class="text-xs text-purple-500">Online</p>
                    </div>
                </div>
                <a href="{% url 'logout' %}" class="info-link text-red-400 hover:bg-red-50">
                    <span class="material-symbols-outlined text-lg">logout</span>
                    Log out
                </a>
            </div>
        </aside>

    </div>

   
</body>

 <script>
        const roomName = "{{ room_name }}";
        const currentUser = "{{ request.user.username }}";
        const chatLog = document.getElementById('chat-log');
        chatLog.scrollTop = chatLog.scrollHeight;

        const socket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + roomName + "/");

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            // Remove empty state if present
            const emptyState = chatLog.querySelector('.flex.flex-col.items-center');
            if (emptyState) emptyState.remove();

            const isSent = data.username === currentUser;
            const isOwn = data.username === "{{ request.user.username }}";
            const div = document.createElement('div');
            
            if (isSent) {
                // Sent message (right side, purple)
                div.className = 'flex justify-end';
                div.innerHTML = `
                    <div class="max-w-md">
                        <p class="text-xs text-gray-400 text-right mb-1">just now</p>
                        <div class="msg-sent px-4 py-3 text-sm shadow-sm">
                            ${data.message}
                        </div>
                    </div>
                `;
            } else {
                // Received message (left side, white)
                div.className = 'flex gap-3';
                div.innerHTML = `
                    <div class="w-9 h-9 rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0" style="background: linear-gradient(135deg, #7C3AED 0%, #C4B5FD 100%);">
                        ${data.username[0].toUpperCase()}
                    </div>
                    <div class="max-w-md">
                        <p class="text-xs text-gray-500 mb-1">
                            <span class="font-medium text-gray-700">${data.username}</span>
                            · just now
                        </p>
                        <div class="msg-received px-4 py-3 text-sm shadow-sm">
                            ${data.message}
                        </div>
                    </div>
                `;
            }
            
            chatLog.appendChild(div);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        socket.onclose = () => console.log("WebSocket closed");

        document.getElementById('messageInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();
            if (!msg) return;
            socket.send(JSON.stringify({ message: msg }));
            input.value = '';
        }
</script>
<style>
        body { font-family: 'Varela Round', sans-serif; }
        
        /* Channel item in sidebar */
        .channel-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .channel-item:hover { background: #f3e8ff; }
        .channel-item.active { background: #ede9fe; }
        
        /* Online status dot */
        .online-dot {
            width: 10px;
            height: 10px;
            background: #9B76B4;
            border-radius: 50%;
            border: 2px solid white;
            position: absolute;
            bottom: 0;
            right: 0;
        }
        
        /* Message bubbles */
        .msg-sent {
            background: linear-gradient(135deg, #9B76B4 0%, #7c3aed 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
        }
        .msg-received {
            background: white;
            color: #374151;
            border-radius: 18px 18px 18px 4px;
        }
        
        /* Info panel link */
        .info-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            color: #6b7280;
            font-size: 14px;
            transition: all 0.15s;
        }
        .info-link:hover { background: #f3e8ff; color: #7c3aed; }
   
    </style>
</html>